
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // PUBLIC COLLECTIONS (read-only for everyone)
    match /blog/{postId} {
      allow read: if true;
      allow write: if isAuth(); 
    }
    match /resources/{resourceId} {
      allow read: if true;
      allow write: if isAuth(); 
    }
    match /reviews/{reviewId} {
        allow read: if true;
        allow create: if true; 
        allow update: if isAuth();
        allow delete: if isAuth();
    }
    match /testCategories/{categoryId} {
        allow read: if true;
        allow write: if isAuth(); 
    }
    match /mockTests/{testId} {
        allow read: if true;
        allow write: if isAuth(); 
    }

    // USER-SPECIFIC COLLECTIONS
    match /userProgress/{userId} {
        allow read, write: if isOwner(userId);
    }
    
    // CONTACT & ENROLLMENT (write-only for users)
    match /contacts/{contactId} {
        allow read: if isAuth();
        allow create: if true;
        allow delete: if isAuth();
    }
    match /enrollments/{enrollmentId} {
        allow read: if isAuth();
        allow create: if true;
        allow update: if isAuth();
        allow delete: if isAuth();
    }
    match /examRegistrations/{userId} {
        allow read, write: if isOwner(userId) || isAuth(); // Allow admin read
    }
    match /examResults/{resultId} {
        allow read: if true; // Results can be public if link is known
        allow create: if true; 
        allow delete: if isAuth();
    }
     match /certificates/{certId} {
      allow read: if true;
      allow write: if isAuth();
    }
     match /counters/{counterId} {
        allow read, write: if isAuth();
    }

    // ADMIN-MANAGED COLLECTIONS (read for all, write only for admin)
    // For simplicity in this context, we allow any authenticated user to write.
    // In a production app, you'd check for an admin custom claim.
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAuth();
    }
    match /learningCourses/{courseId}/{document=**} {
        allow read: if true;
        allow write: if isAuth();
    }
    match /site_settings/{settingId} {
       allow read: if true;
       allow write: if isAuth();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
